# Информация о Sitemap (многостраничный)

## Структура

Используется **sitemap index** (многостраничный sitemap) для поддержки большого количества URL.

### Главный файл
- `/sitemap.xml` - sitemap index, который ссылается на отдельные sitemap файлы

### Отдельные sitemap файлы

1. **`/sitemap-static.xml`** - Статические страницы (5 шт.)
2. **`/sitemap-guides.xml`** - Инструкции (все опубликованные)
3. **`/sitemap-articles.xml`** - Статьи (все опубликованные)
4. **`/sitemap-interpretations-{page}.xml`** - Толкования сновидений (с пагинацией)
5. **`/sitemap-reports-{page}.xml`** - Публичные отчеты (с пагинацией)
6. **`/sitemap-report-analyses-{page}.xml`** - Анализы отчетов (с пагинацией)

## Лимиты

- **Максимум URL в одном sitemap:** 50,000 (рекомендация Google)
- **Практический лимит для пагинации:** 10,000 URL на страницу (для производительности)
- **Максимум sitemap файлов в index:** 50,000 (рекомендация Google)

## Что включается в sitemap

### 1. Статические страницы (`sitemap-static.xml`)
- Главная страница `/` - приоритет 1.0, ежедневно
- Толкование снов `/tolkovanie-snov` - приоритет 0.9, еженедельно
- Инструкции `/guide` - приоритет 0.8, еженедельно
- Статьи `/articles` - приоритет 0.8, еженедельно
- Лента активности `/activity` - приоритет 0.7, ежедневно

**Количество:** 5 страниц

### 2. Инструкции (`sitemap-guides.xml`)
- Все опубликованные инструкции (`type = 'guide'`, `status = 'published'`)
- URL: `/guide/{slug}`
- Приоритет: 0.8
- Частота: ежемесячно

**Количество:** Все опубликованные инструкции

### 3. Статьи (`sitemap-articles.xml`)
- Все опубликованные статьи (`type = 'article'`, `status = 'published'`)
- URL: `/articles/{slug}`
- Приоритет: 0.7
- Частота: ежемесячно

**Количество:** Все опубликованные статьи

### 4. Толкования сновидений (`sitemap-interpretations-{page}.xml`)
- **Условия включения:**
  - `processing_status = 'completed'` (обработка завершена)
  - `api_error IS NULL` (нет ошибок API)
  - Есть нормализованный результат (`result` существует)
  - **Создано после 16.01.2026** (отладочные толкования до этой даты исключены)
  - SEO заголовок не пустой и не дефолтный
  - Заголовок не содержит "Анализ сна" или "Анализ серии снов"
  - Длина заголовка больше 30 символов

- URL: `/tolkovanie-snov/{hash}`
- Приоритет: 0.6
- Частота: ежемесячно
- **Пагинация:** Если толкований больше 10,000, создаются дополнительные файлы (`sitemap-interpretations-1.xml`, `sitemap-interpretations-2.xml`, и т.д.)

**Количество:** Все готовые толкования после 16.01.2026 с валидными заголовками

### 5. Публичные отчеты (`sitemap-reports-{page}.xml`)
- **Условия включения:**
  - `status = 'published'` (опубликован)
  - `access_level = 'all'` (доступен всем)
  - Дневник пользователя публичный (`diary_privacy = 'public'`)

- URL: `/reports/{id}`
- Приоритет: 0.5
- Частота: еженедельно
- **Пагинация:** Если отчетов больше 10,000, создаются дополнительные файлы

**Количество:** Все публичные отчеты (без ограничений)

### 6. Анализы публичных отчетов (`sitemap-report-analyses-{page}.xml`)
- **Условия включения:**
  - Отчет публичный (условия как выше)
  - Есть анализ (`hasAnalysis() = true`)
  - SEO заголовок валидный (не пустой, длина > 30 символов)

- URL: `/reports/{id}/analysis`
- Приоритет: 0.6
- Частота: ежемесячно
- **Пагинация:** Если анализов больше 10,000, создаются дополнительные файлы

**Количество:** Все публичные отчеты с валидными анализами

## Преимущества многостраничного sitemap

1. **Масштабируемость** - можно добавлять неограниченное количество URL
2. **Производительность** - каждый sitemap файл генерируется отдельно
3. **Гибкость** - можно обновлять отдельные части sitemap независимо
4. **Соответствие стандартам** - соответствует рекомендациям Google

## Проверка SEO заголовков

### Для толкований
Sitemap проверяет каждое толкование перед добавлением:
1. Генерирует SEO данные через `SeoHelper::forDreamAnalyzerResult()`
2. Проверяет, что:
   - `title` не пустой
   - `description` не пустой
   - `title` не содержит дефолтные паттерны ("Анализ сна", "Анализ серии снов")
   - Длина заголовка больше 30 символов

### Для анализов отчетов
Аналогичная проверка через `SeoHelper::forReportAnalysis()`:
- `title` не пустой
- `description` не пустой
- Длина заголовка больше 30 символов

## Тестирование

Для проверки sitemap:

1. **Главный index:** `http://127.0.0.1:3000/sitemap.xml`
2. **Статические страницы:** `http://127.0.0.1:3000/sitemap-static.xml`
3. **Инструкции:** `http://127.0.0.1:3000/sitemap-guides.xml`
4. **Статьи:** `http://127.0.0.1:3000/sitemap-articles.xml`
5. **Толкования (страница 1):** `http://127.0.0.1:3000/sitemap-interpretations-1.xml`
6. **Отчеты (страница 1):** `http://127.0.0.1:3000/sitemap-reports-1.xml`
7. **Анализы (страница 1):** `http://127.0.0.1:3000/sitemap-report-analyses-1.xml`

## Обновление sitemap

Sitemap генерируется динамически при каждом запросе, поэтому:
- Новые толкования автоматически появятся после завершения обработки
- Обновления статей/инструкций сразу отражаются
- Новые публичные отчеты автоматически добавляются
- Не требуется ручное обновление

## Примечания

- Толкования с ошибками (`api_error IS NOT NULL`) не включаются
- Толкования без нормализованного результата не включаются
- Толкования с дефолтными/пустыми заголовками не включаются
- Толкования до 16.01.2026 исключены (отладочные)
- Анализы отчетов включаются только для публичных отчетов с валидными SEO заголовками
- Анализы с ошибками при генерации SEO пропускаются (логируются в лог-файл)
- Каждый sitemap файл может содержать до 10,000 URL (для производительности)
- Если элементов больше 10,000, автоматически создаются дополнительные страницы
